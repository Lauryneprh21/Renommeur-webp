<!doctype html>
<html lang="fr">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Convertir & Renommer images — WebP</title>
  <style>
    :root{--bg:#0b0c10;--card:#121318;--muted:#9aa3b2;--text:#e7ecf3;--accent:#6ee7b7;--danger:#f87171}
    *{box-sizing:border-box}
    html,body{height:100%}
    body{margin:0;background:linear-gradient(135deg,#0b0c10,#141824);color:var(--text);font:16px/1.45 system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,"Helvetica Neue",Arial}
    .wrap{max-width:860px;margin:40px auto;padding:24px}
    .card{background:linear-gradient(180deg,rgba(255,255,255,0.04),rgba(255,255,255,0.02));backdrop-filter: blur(6px);border:1px solid rgba(255,255,255,0.08);border-radius:18px;padding:22px;box-shadow:0 10px 30px rgba(0,0,0,.25)}
    h1{font-size:28px;margin:0 0 8px}
    .sub{color:var(--muted);margin:0 0 16px}
    .row{display:grid;grid-template-columns:1fr 1fr;gap:12px}
    label{font-size:12px;color:var(--muted);display:block;margin-bottom:6px}
    input[type="text"],input[type="number"]{width:100%;padding:10px 12px;border-radius:12px;border:1px solid rgba(255,255,255,0.12);background:#0f1118;color:var(--text)}
    input[type="number"]{appearance:textfield}
    .btn{appearance:none;border:0;border-radius:14px;padding:12px 16px;font-weight:600;color:#0b0c10;background:var(--accent);cursor:pointer;transition:transform .06s ease, filter .2s ease}
    .btn:hover{transform:translateY(-1px);filter:brightness(1.05)}
    .controls{display:flex;flex-wrap:wrap;gap:10px;margin:14px 0 6px}
    .hint{font-size:12px;color:var(--muted)}
    .panel{margin-top:18px;padding:14px;border-radius:14px;background:rgba(255,255,255,0.03);border:1px solid rgba(255,255,255,0.07)}
    .zone{border:1.5px dashed rgba(255,255,255,.18);border-radius:16px;padding:18px;text-align:center;color:var(--muted);transition:background .2s}
    .zone.dragover{background:rgba(167,139,250,.1)}
    .log{font-family:ui-monospace,Menlo,Consolas,monospace;font-size:12px;white-space:pre-wrap;max-height:220px;overflow:auto}
  </style>
  <script src="https://cdn.jsdelivr.net/npm/heic2any/dist/heic2any.min.js"></script>
</head>
<body>
  <div class="wrap">
    <div class="card">
      <h1>Convertir & Renommer images en WebP</h1>
      <p class="sub">Choisis ton préfixe et l’index de départ → toutes tes images (HEIC, JPG, PNG…) seront renommées et converties en <code>.webp</code> localement.</p>

      <div class="row">
        <div>
          <label for="prefix">Préfixe</label>
          <input id="prefix" type="text" value="IOMA_Photos" />
        </div>
        <div>
          <label for="start">Index de départ</label>
          <input id="start" type="number" min="1" value="1" />
        </div>
      </div>

      <div class="panel">
        <div id="drop" class="zone">Dépose tes images ici (ou clique pour sélectionner)</div>
        <input type="file" id="filePicker" hidden multiple accept="image/*,.heic" />
        <div id="count" class="hint" style="margin-top:8px"></div>
        <div class="controls">
          <button class="btn" id="download">Télécharger les WebP renommés</button>
        </div>
      </div>

      <div class="panel">
        <strong>Journal</strong>
        <div id="log" class="log"></div>
      </div>
    </div>
  </div>

<script>
(function(){
  const prefixEl=document.getElementById('prefix');
  const startEl=document.getElementById('start');
  const drop=document.getElementById('drop');
  const picker=document.getElementById('filePicker');
  const downloadBtn=document.getElementById('download');
  const countEl=document.getElementById('count');
  const logEl=document.getElementById('log');

  function log(msg, cls){ const d=document.createElement('div'); if(cls) d.className=cls; d.textContent=msg; logEl.appendChild(d); logEl.scrollTop=logEl.scrollHeight; }

  let dropped=[];
  function refreshCount(){ countEl.textContent=dropped.length? `${dropped.length} image(s) prêtes.` : ''; }

  drop.addEventListener('click', ()=> picker.click());
  drop.addEventListener('dragover', e=>{ e.preventDefault(); drop.classList.add('dragover'); });
  drop.addEventListener('dragleave', ()=> drop.classList.remove('dragover'));
  drop.addEventListener('drop', e=>{
    e.preventDefault(); drop.classList.remove('dragover');
    dropped.push(...Array.from(e.dataTransfer.files));
    dropped.sort((a,b)=> a.name.localeCompare(b.name,undefined,{numeric:true}));
    refreshCount();
  });
  picker.addEventListener('change', e=>{
    dropped.push(...Array.from(e.target.files));
    dropped.sort((a,b)=> a.name.localeCompare(b.name,undefined,{numeric:true}));
    refreshCount();
  });

  async function toWebP(file){
    const isHeic = /\.heic$/i.test(file.name) || file.type.includes('heic') || file.type.includes('heif');
    // HEIC/HEIF → heic2any si dispo (utile pour Chrome)
    if(isHeic && window.heic2any){
      try{
        const blob = await window.heic2any({ blob: file, toType: 'image/webp', quality: 0.9 });
        return blob; // déjà en webp
      }catch(err){
        console.error('heic2any error:', err);
        // fallback: tentera via <img> (marchera surtout sur Safari)
      }
    }
    // Images classiques (jpg, png, etc.) ou fallback
    return new Promise((resolve, reject)=>{
      const reader=new FileReader();
      reader.onload=()=>{
        const img=new Image();
        img.onload=()=>{
          try{
            const canvas=document.createElement('canvas');
            canvas.width=img.width; canvas.height=img.height;
            canvas.getContext('2d').drawImage(img,0,0);
            canvas.toBlob(b=> b? resolve(b) : reject(new Error('toBlob failed')),'image/webp',0.9);
          }catch(e){ reject(e); }
        };
        img.onerror=()=>reject(new Error('decode failed'));
        img.src=reader.result;
      };
      reader.onerror=()=>reject(new Error('read failed'));
      reader.readAsDataURL(file);
    });
  }

  downloadBtn.addEventListener('click', async ()=>{
    if(!dropped.length){ alert('Dépose au moins une image'); return; }
    const start=parseInt(startEl.value||1,10);
    let i=0;
    for(const f of dropped){
      try{
        const blob=await toWebP(f);
        const url=URL.createObjectURL(blob);
        const a=document.createElement('a');
        a.href=url;
        a.download=`${prefixEl.value}${start+i}.webp`;
        i++;
        document.body.appendChild(a); a.click(); a.remove();
        URL.revokeObjectURL(url);
        await new Promise(r=>setTimeout(r,80));
        log(`✅ ${f.name} → ${a.download}`);
      }catch(err){ log(`❌ Échec : ${f.name}`,'err'); }
    }
    log(`Téléchargement terminé pour ${dropped.length} image(s).`);
  });
})();
</script>
</body>
</html>
